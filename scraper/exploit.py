from bs4 import BeautifulSoup
import traceback
import requests
import time
import os




class Download_Templates:
    def __init__(self):
        self.topic_counter = 130
        self.session = requests.session()
        self.path = os.getcwd()
        if not os.path.exists('%s/exploit' %self.path):
            os.makedirs('%s/exploit' %self.path)
        self.complete_path = '%s/exploit' %self.path


    def Request(self, s, url):
        time.sleep(.5)
        try:
            page = s.get(url)
            return page.content
        except:
            return None

    def login(self):
        payload = {
            'UserName': 'NightCat',
            'PassWord': '2PK&fx2i%yL%FsIMwJaE5gfr'
        }
        s = requests.Session()
        s.post('https://forum.exploit.in/index.php?s=0&act=Login&CODE=01', data=payload)
        #print('successfully login...!')
        return s


    def write_data(self, page, topic):
        f = open('%s/%d.html' %(self.complete_path, topic), 'wb')
        f.write(page)
        f.close()

    def write_data_pagination(self, s, page, topic, pagination):
        f = open('%s/%d-%d.html' %(self.complete_path, topic, pagination), 'wb')
        f.write(page)
        f.close()


    def clear_cookies(self, s):
        s.cookies['topicsread'] = ''
        return s

    def main(self):
        print('**************  Script Is Running  **************\n')
        s = self.login()
        #go to topic ------------------
        for topic in range(30810, 151364):
            try:
                url = 'https://forum.exploit.in/index.php?showtopic=%d' %topic
                page = self.Request(s, url)

                #getting pagination number----
                try:
                    soup = BeautifulSoup(page, 'html.parser')
                    pagi = soup.select_one('span.pagelink a').text.split()[0]  
                except:
                    pagi = 0

                self.write_data(page, topic)
                print('%d done..!' %topic)

                #clear cookies without logout--------------
                s = self.clear_cookies(s)

                #if there is no pagination then continue----
                if pagi == 0:
                    continue
            except:
                continue


            #for pagination ------------------
            pagination_counter = 20
            for pagination in range(2, int(pagi)+1):
                try:
                    p_url = 'https://forum.exploit.in/index.php?showtopic=%d&st=%d' %(topic, pagination_counter)
                    page = self.Request(s, p_url)

                    if page == None:
                        break

                    self.write_data_pagination(s, page, topic, pagination)
                    print('%d-%d done..!' %(topic, pagination))
                    pagination_counter += 20
                except:
                    continue
       
obj = Download_Templates()
obj.main()
